<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</title>
  <style>
    :root{
      --w50:#eff6ff;--w100:#dbeafe;--w700:#1d4ed8;--w800:#1e40af;
      --text:#0f172a;--muted:#64748b;--bg:#f6f8fc;--border:#e5e7eb;
      --red:#dc2626;--green:#065f46;--card:#fff;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Naskh Arabic",Arial}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{background:var(--w800);color:#fff}
    header .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 24px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .btn{border:0;background:var(--w700);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.ghost{background:#eef2ff;color:#1e3a8a} .btn.warn{background:#fef3c7;color:#92400e}
    .btn.danger{background:#fee2e2;color:#991b1b} .muted{color:var(--muted)}
    .grid{display:grid;gap:16px} .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))} .row{display:flex;align-items:center;gap:10px}
    .badge{display:inline-block;background:var(--w100);color:var(--w800);padding:2px 8px;border-radius:999px;font-size:12px}
    .list{display:grid;gap:10px} .list .item{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;outline:none}
    .input:focus,select:focus{box-shadow:0 0 0 3px rgba(37,99,235,.2);border-color:var(--w700)}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap} .tab{padding:8px 12px;border-radius:12px;background:#e5e7eb;font-weight:700}
    .tab.active{background:var(--w100);color:var(--w800)}
    .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden} .progress>div{height:100%;background:linear-gradient(90deg,var(--w700),#2563eb)}
    .avatar{width:64px;height:64px;border-radius:999px;object-fit:cover;border:1px solid #c7d2fe;background:#fff}
    .avatar-lg{width:80px;height:80px;border-radius:999px;object-fit:cover;border:2px solid #c7d2fe;background:#fff}
    .money{font-variant-numeric:tabular-nums} .danger{color:var(--red)} .success{color:var(--green)} .tiny{font-size:12px}
    footer{color:#94a3b8;font-size:13px;text-align:center;padding:28px 10px}
    @media (max-width:900px){.grid-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:700px){.grid-2,.grid-3{grid-template-columns:1fr}}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:center;padding:20px;z-index:40}
    .modal{width:100%;max-width:420px;background:#fff;border-radius:16px;padding:20px}
  </style>
</head>
<body>
<header>
  <div class="bar container">
    <div class="row">
      <img src="https://i.postimg.cc/tTSfNWkn/image.jpg" class="avatar" alt="Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²"/>
      <strong>Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</strong>
      <span id="sync-badge" class="badge">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„â€¦</span>
    </div>
    <nav class="row" style="gap:12px">
      <button class="btn ghost" id="nav-home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="btn ghost" id="nav-admin">Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù†</button>
      <button class="btn ghost" id="nav-signout" style="display:none">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </nav>
  </div>
</header>

<main class="container" id="view-root"></main>

<!-- PIN Modal -->
<div class="overlay" id="pin-overlay">
  <div class="modal card">
    <h3 style="margin:0 0 6px 0">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ</h3>
    <div class="tiny muted" id="pin-desc" style="margin-bottom:8px"></div>
    <input class="input" id="pin-input" type="password" inputmode="numeric" maxlength="4" placeholder="Ø£Ø±Ø¨Ø¹ Ø®Ø§Ù†Ø§Øª"/>
    <div class="row" style="margin-top:12px;gap:8px">
      <button class="btn" id="pin-ok">ØªØ£ÙƒÙŠØ¯</button>
      <button class="btn" id="pin-cancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
    <div class="tiny danger" id="pin-err" style="display:none;margin-top:6px"></div>
  </div>
</div>

<footer>Â© <span id="year"></span> Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ø± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©</footer>

<!-- Firebase compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/*** 0) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase â€” Ø¨Ø¯Ù‘Ù„ ADMIN_UID Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨Ù€Ù€ UID Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² ***/
const firebaseConfig = {
  apiKey: "AIzaSyC-KXnFzEliSECIH4jWI8Hf28eFuWRTn-c",
  authDomain: "world-savings-bank-5df02.firebaseapp.com",
  databaseURL: "https://world-savings-bank-5df02-default-rtdb.firebaseio.com",
  projectId: "world-savings-bank-5df02",
  storageBucket: "world-savings-bank-5df02.appspot.com",
  messagingSenderId: "361127802397",
  appId: "1:361127802397:web:cb0cc9dfa6d5d2db4238f4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

const ADMIN_UID = "Lbh9chEH2cdPBEoZh3BYCVj2Ijp2"; // ğŸ‘ˆ Ø¶Ø¹ UID Ø­Ø³Ø§Ø¨ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ù‡Ù†Ø§

/*** 1) Ø«ÙˆØ§Ø¨Øª ÙˆØµÙˆØ± ***/
const IMG = {
  admin: "https://i.postimg.cc/tTSfNWkn/image.jpg",
  omar:  "https://i.postimg.cc/LsmbdN0Z/image.jpg",
  shahad:"https://i.postimg.cc/d1xHyvQ8/image.jpg"
};
const PINS = { omar:'4000', shahad:'5000', admin:'9000' };

/*** 2) Ø­Ø§Ù„Ø© ÙˆØ§Ø¬Ù‡Ø© ***/
let ACCOUNTS = { omar:{name:'Ø¹Ù…Ø±',balance:0,goal:{}}, shahad:{name:'Ø´Ù‡Ø¯',balance:0,goal:{}} };
let TX = [];          // Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©/Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©
let REQ_TX = {};      // Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©)
let user = null;

/*** 3) Ù…ØµØ§Ø¯Ù‚Ø©: ØªØ³Ø¬ÙŠÙ„ Ù…Ø¬Ù‡ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„Ø£ÙˆÙ„Ø§Ø¯ ***/
auth.onAuthStateChanged(async u=>{
  user = u;
  document.getElementById('nav-signout').style.display = u? 'inline-flex':'none';
  document.getElementById('sync-badge').textContent = u? 'Ù…ØªØµÙ„':'ØºÙŠØ± Ù…ØªØµÙ„';
  if(!u){ await auth.signInAnonymously(); return; }

  db.ref('accounts').on('value', snap=>{
    ACCOUNTS = snap.val() || ACCOUNTS; route();
  });
  db.ref('transactions').on('value', snap=>{
    const arr=[]; snap.forEach(c=>arr.push({id:c.key,...c.val()}));
    TX = arr.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)); route();
  });
  db.ref('requests/transactions').on('value', snap=>{
    REQ_TX = snap.val() || {}; route();
  });
});

/*** 4) Ø£Ø¯ÙˆØ§Øª ***/
const root = document.getElementById('view-root');
const fmt = n=>Number(n||0).toLocaleString('ar-SA');
const fmtDate = ms=> new Date(ms).toLocaleString('ar-SA');
document.getElementById('year').textContent = new Date().getFullYear();
const uid = ()=> Math.random().toString(36).slice(2)+Date.now().toString(36);

/*** 5) ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø³ÙŠØ· ***/
document.getElementById('nav-home').onclick = ()=>location.hash = '#home';
document.getElementById('nav-admin').onclick = ()=>location.hash = '#admin';
document.getElementById('nav-signout').onclick = ()=>auth.signOut();
window.addEventListener('hashchange', route);
function route(){
  const h = location.hash.replace('#','') || 'home';
  if(h.startsWith('account=')){
    const id = h.split('=')[1];
    openWithPin(id, ()=> renderAccount(id));
  }else if(h==='admin'){
    openWithPin('admin', ()=> renderAdmin());
  }else{
    renderHome();
  }
}

/*** 6) Ù…ÙˆØ¯Ø§Ù„ PIN ***/
const ovl = document.getElementById('pin-overlay'), pinIn = document.getElementById('pin-input'),
      pinErr = document.getElementById('pin-err'), pinDesc = document.getElementById('pin-desc');
document.getElementById('pin-cancel').onclick = ()=>{ovl.style.display='none';};
document.getElementById('pin-ok').onclick = confirmPin;
let pinTarget='', onPinOk=()=>{};
const pinFail={omar:0,shahad:0,admin:0}, lockUntil={omar:0,shahad:0,admin:0};
function openWithPin(target, ok){
  pinTarget = target; onPinOk = ok;
  const now=Date.now();
  if(lockUntil[target] && now<lockUntil[target]){ alert('Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø© Ø®Ø§Ø·Ø¦Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.'); return; }
  pinDesc.textContent = target==='admin'? 'Ù„ÙˆØ­Ø© Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²' : `Ø­Ø³Ø§Ø¨ ${target==='omar'?'Ø¹Ù…Ø±':'Ø´Ù‡Ø¯'}`;
  pinIn.value=''; pinErr.style.display='none'; ovl.style.display='grid'; setTimeout(()=>pinIn.focus(),50);
}
function confirmPin(){
  const v = pinIn.value.trim();
  if(v === PINS[pinTarget]){ pinFail[pinTarget]=0; ovl.style.display='none'; onPinOk(); }
  else{
    pinFail[pinTarget]=(pinFail[pinTarget]||0)+1;
    if(pinFail[pinTarget]>=3){ lockUntil[pinTarget]=Date.now()+60000; pinErr.textContent='ØªÙ… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ 60 Ø«Ø§Ù†ÙŠØ©.'; }
    else pinErr.textContent='Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ.';
    pinErr.style.display='block';
  }
}

/*** 7) ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ***/
function goalPct(a){ const g=a.goal||{}; if(!g.amount||!g.approved) return 0;
  return Math.max(0,Math.min(100,Math.round((a.balance/g.amount)*100)));
}
function renderHome(){
  const pendingCount = Object.values(REQ_TX).filter(r=>r && r.status!=='rejected' && r.status!=='approved').length;
  root.innerHTML = `
    <section class="card" style="padding:16px;background:linear-gradient(90deg,var(--w800),var(--w700));color:#fff">
      <div style="font-weight:700">Ù…Ø±Ø­Ø¨Ù‹Ø§!</div>
      <div class="tiny" style="color:#e5e7eb">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ø§ØªÙƒ Ø£Ùˆ Ø§Ø¯Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù† Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©.</div>
      ${pendingCount? `<div class="badge" style="margin-top:6px;background:#fff;color:#111827">Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: ${pendingCount}</div>`:''}
    </section>

    <section class="grid grid-2" style="margin-top:12px">
      ${['omar','shahad'].map(id=>{
        const a=ACCOUNTS[id]||{name:id,balance:0,goal:{}}, img=id==='omar'?IMG.omar:IMG.shahad;
        const g=a.goal||{}, p=goalPct(a);
        return `
          <div class="card" style="padding:16px">
            <div class="row" style="gap:12px">
              <img class="avatar" src="${img}" alt="${a.name}"/>
              <div style="flex:1">
                <div class="muted tiny">Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨</div>
                <div class="money" style="font-weight:800;font-size:22px">${fmt(a.balance)} Ø±.Ø³</div>
                <div class="tiny" style="margin-top:4px;color:#1e3a8a">Ø­Ø³Ø§Ø¨ ${a.name} Ø§Ù„Ø¥Ø¯Ø®Ø§Ø±ÙŠ</div>
                ${g.amount?`
                  <div class="tiny muted" style="margin-top:6px">Ø§Ù„Ù‡Ø¯Ù: ${g.title?g.title+' - ':''}${fmt(g.amount)} Ø±.Ø³ ${g.approved?'<span class="badge">Ù…ÙØ¹ØªÙ…Ø¯</span>':'<span class="badge" style="background:#fee2e2;color:#991b1b">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø©</span>'}</div>
                  ${g.approved?`<div class="progress" style="margin-top:6px"><div style="width:${p}%"></div></div><div class="tiny muted">${p}%</div>`:''}
                `:''}
              </div>
              <button class="btn" onclick="location.hash='account=${id}'">ÙØªØ­</button>
            </div>
          </div>`;
      }).join('')}
    </section>

    <section style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
      ${renderTxList(null, 6)}
    </section>
  `;
}

/*** 8) ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ø§Øª) ***/
async function sendTxRequest(payload){
  if(!payload.amount || payload.amount<=0) return alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
  await db.ref('requests/transactions').push({
    ...payload, createdAt: Date.now(),
    createdBy: auth.currentUser? auth.currentUser.uid : null,
    status: 'pending'
  });
  alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¢Ø¯Ù…Ù†.');
}
function renderAccount(id){
  const a=ACCOUNTS[id]||{name:id,balance:0,goal:{}}, img=id==='omar'?IMG.omar:IMG.shahad;
  const g=a.goal||{}, p=goalPct(a);
  root.innerHTML=`
    <section class="card" style="padding:16px">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:12px">
          <img class="avatar-lg" src="${img}" alt="${a.name}"/>
          <div>
            <div class="muted tiny">Ø±ØµÙŠØ¯ ${a.name}</div>
            <div class="money" style="font-weight:800;font-size:26px">${fmt(a.balance)} Ø±.Ø³</div>
          </div>
        </div>
        <button class="btn ghost" onclick="location.hash='#home'">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>
    </section>

    <section class="grid grid-2" style="margin-top:12px">
      <div class="card" style="padding:16px">
        <div class="tabs">
          <div class="tab active" id="t-dep">Ø¥ÙŠØ¯Ø§Ø¹</div>
          <div class="tab" id="t-exp">Ù…ØµØ±ÙˆÙ</div>
          <div class="tab" id="t-trf">ØªØ­ÙˆÙŠÙ„</div>
        </div>
        <div id="f-dep">
          <input class="input" id="dep-amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø±ÙŠØ§Ù„"/>
          <input class="input" id="dep-note"   type="text"   placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-top:8px"/>
          <button class="btn" style="margin-top:10px" onclick="sendTxRequest({accountId:'${id}',type:'deposit',amount:Number(document.getElementById('dep-amount').value||0),note:document.getElementById('dep-note').value})">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨</button>
        </div>
        <div id="f-exp" style="display:none">
          <input class="input" id="exp-amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø±ÙŠØ§Ù„"/>
          <input class="input" id="exp-note"   type="text"   placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-top:8px"/>
          <button class="btn" style="margin-top:10px" onclick="sendTxRequest({accountId:'${id}',type:'expense',amount:Number(document.getElementById('exp-amount').value||0),note:document.getElementById('exp-note').value})">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨</button>
        </div>
        <div id="f-trf" style="display:none">
          <input class="input" id="trf-amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø±ÙŠØ§Ù„"/>
          <select class="input" id="trf-to" style="margin-top:8px">
            <option value="abdulaziz">Ø­Ø³Ø§Ø¨ Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²</option>
            <option value="omar">Ø­Ø³Ø§Ø¨ Ø¹Ù…Ø±</option>
            <option value="shahad">Ø­Ø³Ø§Ø¨ Ø´Ù‡Ø¯</option>
          </select>
          <button class="btn" style="margin-top:10px" onclick="sendTxRequest({accountId:'${id}',type:'transfer',to:document.getElementById('trf-to').value,amount:Number(document.getElementById('trf-amount').value||0)})">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨</button>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)"/>
        <div>
          <div class="tiny muted" style="margin-bottom:6px">Ù‡Ø¯Ù Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</div>
          <input class="input" id="goal-title" type="text" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‡Ø¯Ù" value="${g.title||''}"/>
          <input class="input" id="goal-amount" type="number" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ù‡Ø¯Ù" value="${g.amount||''}" style="margin-top:8px"/>
          <button class="btn" style="margin-top:10px" onclick="sendGoal('${id}')">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ù Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©</button>
          ${g.approved? `<div class="progress" style="margin-top:8px"><div style="width:${p}%"></div></div><div class="tiny muted">${p}%</div>` : (g.amount? '<div class="tiny muted" style="margin-top:6px">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø©</div>':'')}
        </div>
      </div>

      <div class="card" style="padding:16px">
        <div class="row" style="justify-content:space-between;margin-bottom:8px">
          <h3 style="margin:0">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
          <span class="badge">Ø§Ù„Ø­Ø³Ø§Ø¨: ${a.name}</span>
        </div>
        ${renderTxList(id)}
      </div>
    </section>
  `;
  const tdep=document.getElementById('t-dep'), texp=document.getElementById('t-exp'), ttrf=document.getElementById('t-trf');
  const fdep=document.getElementById('f-dep'), fexp=document.getElementById('f-exp'), ftrf=document.getElementById('f-trf');
  tdep.onclick=()=>{tdep.classList.add('active');texp.classList.remove('active');ttrf.classList.remove('active');fdep.style.display='block';fexp.style.display='none';ftrf.style.display='none';};
  texp.onclick=()=>{texp.classList.add('active');tdep.classList.remove('active');ttrf.classList.remove('active');fexp.style.display='block';fdep.style.display='none';ftrf.style.display='none';};
  ttrf.onclick=()=>{ttrf.classList.add('active');tdep.classList.remove('active');texp.classList.remove('active');ftrf.style.display='block';fdep.style.display='none';};
}

async function sendGoal(id){
  const title=document.getElementById('goal-title').value.trim();
  const amount=Number(document.getElementById('goal-amount').value||0);
  if(!amount||amount<=0) return alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
  await db.ref('requests/goals/'+id).push({title,amount,createdAt:Date.now(),createdBy:user?.uid||null,status:'pending'});
  alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‡Ø¯Ù Ù„Ù„Ø¢Ø¯Ù…Ù†.');
}

/*** 9) Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ***/
function txLabel(t){
  if(t.type==='deposit') return {label:'Ø¥ÙŠØ¯Ø§Ø¹',sign:'+',cls:'success'};
  if(t.type==='expense') return {label:'Ù…ØµØ±ÙˆÙ',sign:'-',cls:'danger'};
  if(t.type==='transfer' && t.direction==='out') return {label:`ØªØ­ÙˆÙŠÙ„ - Ø®ØµÙ… (${nameOf(t.to)})`,sign:'-',cls:'danger'};
  if(t.type==='transfer' && t.direction==='in')  return {label:`ØªØ­ÙˆÙŠÙ„ - Ø¥Ø¶Ø§ÙØ© (${nameOf(t.from)})`,sign:'+',cls:'success'};
  return {label:t.type,sign:'',cls:''};
}
function nameOf(x){ return x==='omar'?'Ø¹Ù…Ø±':x==='shahad'?'Ø´Ù‡Ø¯':x==='abdulaziz'?'Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²':x; }
function renderTxList(accountId, limit){
  let list = TX.slice();
  if(accountId) list = list.filter(t=> t.accountId===accountId);
  if(limit) list = list.slice(0,limit);
  if(list.length===0) return `<div class="card" style="padding:14px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª</div>`;
  return `<div class="list">${
    list.map(t=>{
      const {label,sign,cls} = txLabel(t);
      return `<div class="item">
        <div>
          <div style="font-weight:700">${label}</div>
          <div class="tiny muted">${fmtDate(t.createdAt)}</div>
          ${t.note? `<div class="tiny" style="margin-top:3px">Ù…Ù„Ø§Ø­Ø¸Ø©: ${t.note.replace(/[&<>"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]))}</div>`:''}
        </div>
        <div class="money ${cls}" style="font-weight:800">${sign}${fmt(t.amount)} Ø±.Ø³</div>
      </div>`;
    }).join('')
  }</div>`;
}

/*** 10) Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù† ***/
async function adminSignIn(email, password){
  const cred = await auth.signInWithEmailAndPassword(email, password);
  if(cred.user.uid !== ADMIN_UID){ alert('Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„ÙŠØ³ Ø¢Ø¯Ù…Ù†'); await auth.signOut(); }
}
async function approveReq(id){
  if(!user || user.uid!==ADMIN_UID) return alert('ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©');
  const snap = await db.ref('requests/transactions/'+id).get();
  if(!snap.exists()) return;
  const r = snap.val();
  const fromRef = db.ref('accounts/'+r.accountId+'/balance');
  if(r.type==='deposit'){
    await fromRef.transaction(x=>(x||0)+r.amount);
    await db.ref('transactions/'+id).set({...r, status:'approved'});
  }else if(r.type==='expense'){
    const ok = await fromRef.transaction(x=>{ x=x||0; if(x<r.amount) return; return x-r.amount; });
    if(!ok.committed) return alert('Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ');
    await db.ref('transactions/'+id).set({...r, status:'approved'});
  }else if(r.type==='transfer'){
    const ok = await fromRef.transaction(x=>{ x=x||0; if(x<r.amount) return; return x-r.amount; });
    if(!ok.committed) return alert('Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ');
    if(r.to==='omar' || r.to==='shahad'){
      await db.ref('accounts/'+r.to+'/balance').transaction(x=>(x||0)+r.amount);
      await db.ref('transactions/'+id+'_out').set({...r, direction:'out', status:'approved'});
      await db.ref('transactions/'+id+'_in').set({ ...r, accountId:r.to, from:r.accountId, direction:'in', status:'approved' });
    }else{
      await db.ref('transactions/'+id).set({...r, direction:'out', status:'approved'});
    }
  }
  await db.ref('requests/transactions/'+id+'/status').set('approved');
}
async function rejectReq(id){
  if(!user || user.uid!==ADMIN_UID) return alert('ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©');
  await db.ref('requests/transactions/'+id+'/status').set('rejected');
  const r = (await db.ref('requests/transactions/'+id).get()).val();
  await db.ref('transactions/'+id).set({...r, status:'rejected'});
}

async function approveGoal(id, reqKey){
  if(!user || user.uid!==ADMIN_UID) return alert('ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©');
  const r = (await db.ref('requests/goals/'+id+'/'+reqKey).get()).val();
  if(!r) return;
  await db.ref('accounts/'+id+'/goal').set({title:r.title,amount:r.amount,approved:true});
  await db.ref('requests/goals/'+id+'/'+reqKey+'/status').set('approved');
}
async function rejectGoal(id, reqKey){
  if(!user || user.uid!==ADMIN_UID) return alert('ØµÙ„Ø§Ø­ÙŠØ§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ©');
  await db.ref('requests/goals/'+id+'/'+reqKey+'/status').set('rejected');
}

function renderAdmin(){
  const isAdmin = user && user.uid===ADMIN_UID;
  const pending = Object.entries(REQ_TX).filter(([k,v])=>v && v.status==='pending');
  root.innerHTML = `
    <section class="card" style="padding:16px">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:12px">
          <img class="avatar-lg" src="${IMG.admin}" alt="Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²"/>
          <div>
            <div class="muted tiny">Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù†</div>
            <div style="font-weight:800">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</div>
            <div class="tiny muted">Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: ${pending.length}</div>
          </div>
        </div>
        <button class="btn ghost" onclick="location.hash='#home'">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>
      ${!isAdmin ? `
        <div class="card" style="padding:16px;margin-top:12px">
          <div class="tiny muted" style="margin-bottom:6px">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ø¯Ù…Ù†</div>
          <input class="input" id="ad-email" type="email" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¢Ø¯Ù…Ù†" value="abdulaziz.algharawi@gmail.com"/>
          <input class="input" id="ad-pass"  type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="margin-top:8px"/>
          <button class="btn" style="margin-top:10px" onclick="adminSignIn(document.getElementById('ad-email').value, document.getElementById('ad-pass').value)">Ø¯Ø®ÙˆÙ„</button>
          <div class="tiny muted" style="margin-top:6px">Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØµØ­ÙŠØ­ØŒ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©/Ø§Ù„Ø±ÙØ¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø©.</div>
        </div>` : `
        <section class="grid grid-3" style="margin-top:12px">
          ${['omar','shahad'].map(id=>{
            const a=ACCOUNTS[id], img=id==='omar'?IMG.omar:IMG.shahad, p=goalPct(a);
            return `<div class="card" style="padding:16px">
              <div class="row" style="gap:12px">
                <img class="avatar" src="${img}" alt="${a.name}"/>
                <div>
                  <div class="muted tiny">Ø±ØµÙŠØ¯ ${a.name}</div>
                  <div class="money" style="font-weight:800;font-size:22px">${fmt(a.balance)} Ø±.Ø³</div>
                  ${a.goal?.amount? `<div class="tiny muted" style="margin-top:6px">
                    Ø§Ù„Ù‡Ø¯Ù: ${a.goal.title? a.goal.title+' - ':''}${fmt(a.goal.amount)} Ø±.Ø³ ${a.goal.approved? '<span class="badge">Ù…ÙØ¹ØªÙ…Ø¯</span>':'<span class="badge" style="background:#fee2e2;color:#991b1b">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø©</span>'}
                  </div>${a.goal.approved? `<div class="progress" style="margin-top:6px"><div style="width:${p}%"></div></div>`:''}`:''}
                </div>
              </div>
              <div class="row" style="gap:8px;margin-top:10px">
                <button class="btn" onclick="location.hash='account=${id}'">ÙØªØ­ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
              </div>
            </div>`;}).join('')}
          <div class="card" style="padding:16px">
            <div class="muted tiny">Ø£Ø¯ÙˆØ§Øª</div>
            <div class="row" style="gap:8px;margin-top:8px">
              <button class="btn warn" onclick="if(confirm('ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ')) db.ref('transactions').remove()">ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
              <button class="btn danger" onclick="if(confirm('ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±ØµØ¯Ø©ØŸ')) { db.ref('accounts/omar/balance').set(0); db.ref('accounts/shahad/balance').set(0);}">ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±ØµØ¯Ø©</button>
            </div>
          </div>
        </section>

        <section class="card" style="padding:16px;margin-top:12px">
          <h3 style="margin:0 0 8px 0">Ø·Ù„Ø¨Ø§Øª Ø¹Ù…Ù„ÙŠØ§Øª â€” Ø¨Ø§Ù†ØªØ¸Ø§Ø±</h3>
          ${pending.length? `<div class="list">${
            pending.map(([id,r])=>`
              <div class="item">
                <div>
                  <div style="font-weight:700">${r.type==='deposit'?'Ø¥ÙŠØ¯Ø§Ø¹':r.type==='expense'?'Ù…ØµØ±ÙˆÙ':'ØªØ­ÙˆÙŠÙ„'} â€” ${r.accountId==='omar'?'Ø¹Ù…Ø±':'Ø´Ù‡Ø¯'} ${r.to? 'â†’ '+(r.to==='omar'?'Ø¹Ù…Ø±':r.to==='shahad'?'Ø´Ù‡Ø¯':'Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ²'):''}</div>
                  <div class="tiny muted">${fmtDate(r.createdAt)}</div>
                  ${r.note? `<div class="tiny" style="margin-top:3px">Ù…Ù„Ø§Ø­Ø¸Ø©: ${r.note}</div>`:''}
                </div>
                <div class="row" style="gap:8px">
                  <div class="money" style="font-weight:800">${fmt(r.amount)} Ø±.Ø³</div>
                  <button class="btn" onclick="approveReq('${id}')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                  <button class="btn danger" onclick="rejectReq('${id}')">Ø±ÙØ¶</button>
                </div>
              </div>`).join('')
          }</div>` : `<div class="card" style="padding:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ©</div>`}
        </section>

        <section class="card" style="padding:16px;margin-top:12px">
          <h3 style="margin:0 0 8px 0">Ø·Ù„Ø¨Ø§Øª Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</h3>
          <div id="goal-reqs"></div>
        </section>
        `}
    </section>
  `;

  if(isAdmin){
    Promise.all(['omar','shahad'].map(id=> db.ref('requests/goals/'+id).get().then(s=>({id, val:s.val()||{}})))).then(all=>{
      const items=[];
      all.forEach(({id,val})=>{
        Object.entries(val).forEach(([k,g])=>{
          if(g.status==='approved') return;
          items.push({acc:id, key:k, ...g});
        });
      });
      document.getElementById('goal-reqs').innerHTML = items.length? `<div class="list">${
        items.map(g=>`
          <div class="item">
            <div>
              <div style="font-weight:700">${g.acc==='omar'?'Ø¹Ù…Ø±':'Ø´Ù‡Ø¯'} â€” ${g.title||'Ù‡Ø¯Ù'}</div>
              <div class="tiny muted">${fmt(g.amount)} Ø±.Ø³ â€” ${fmtDate(g.createdAt||Date.now())}</div>
            </div>
            <div class="row" style="gap:6px">
              <button class="btn" onclick="approveGoal('${g.acc}','${g.key}')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
              <button class="btn danger" onclick="rejectGoal('${g.acc}','${g.key}')">Ø±ÙØ¶</button>
            </div>
          </div>`).join('')
      }</div>` : `<div class="card" style="padding:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>`;
    });
  }
}
route();
</script>
</body>
</html>
