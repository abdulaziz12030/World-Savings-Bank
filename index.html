<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>محفظة الادخار العالمية — نسخة بسيطة (بدون خادم)</title>
  <style>
    :root{
      --wblue-50:#eff6ff;--wblue-100:#dbeafe;--wblue-200:#bfdbfe;--wblue-600:#2563eb;--wblue-700:#1d4ed8;--wblue-800:#1e40af;
      --text:#0f172a; --muted:#64748b; --bg:#f6f8fc; --border:#e5e7eb; --red:#dc2626; --green:#065f46; --amber:#b45309;
      --card-bg:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Kufi Arabic","Noto Naskh Arabic",Arial;background:var(--bg);color:var(--text)}
    .container{max-width:1150px;margin:0 auto;padding:24px}
    header{background:var(--wblue-800);color:#fff}
    header .bar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 24px}
    a,button{cursor:pointer}
    .card{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .btn{border:0;background:var(--wblue-700);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700}
    .btn.ghost{background:#eef2ff;color:#1e3a8a}
    .btn.muted{background:#e5e7eb;color:#111827}
    .btn.danger{background:#fee2e2;color:#991b1b}
    .btn.warn{background:#fef3c7;color:#92400e}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .muted{color:var(--muted)}
    .row{display:flex;align-items:center;gap:10px}
    .money{font-variant-numeric:tabular-nums}
    .badge{display:inline-block;background:var(--wblue-100);color:var(--wblue-800);padding:2px 8px;border-radius:999px;font-size:12px}
    .list{display:grid;gap:10px}
    .list .item{display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .danger{color:var(--red)} .success{color:var(--green)} .amber{color:var(--amber)}
    .empty{color:var(--muted);font-size:14px}
    .avatar{width:64px;height:64px;border-radius:999px;object-fit:cover;border:1px solid var(--wblue-200);background:#fff}
    .avatar-lg{width:80px;height:80px;border-radius:999px;object-fit:cover;border:2px solid var(--wblue-200);background:#fff}
    footer{color:#94a3b8;font-size:13px;text-align:center;padding:40px 10px}
    @media (max-width:900px){.grid-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:700px){.grid-2{grid-template-columns:1fr}.grid-3{grid-template-columns:1fr}}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:center;padding:20px;z-index:40}
    .modal{width:100%;max-width:400px;background:#fff;border-radius:16px;padding:20px}
    .input,select{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;outline:none}
    .input:focus,select:focus{box-shadow:0 0 0 3px rgba(37,99,235,.2);border-color:var(--wblue-600)}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:12px;background:#e5e7eb;font-weight:700}
    .tab.active{background:var(--wblue-100);color:var(--wblue-800)}
    .tiny{font-size:12px}
    .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:linear-gradient(90deg,var(--wblue-700),var(--wblue-600))}
    .section-title{margin:0 0 8px 0;font-weight:800}
    .banner{padding:12px;border-radius:12px;margin:12px 0;font-size:14px}
    .banner.ok{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
    .banner.warn{background:#fffbeb;color:#92400e;border:1px solid #fde68a}
  </style>
</head>
<body>
  <header>
    <div class="bar container">
      <div class="row">
        <img src="https://i.postimg.cc/tTSfNWkn/image.jpg" alt="عبدالعزيز" class="avatar"/>
        <strong style="font-size:18px">محفظة الادخار العالمية</strong>
        <span class="badge" id="sync-badge">وضع محلي (بدون مزامنة)</span>
      </div>
      <nav class="row" style="gap:12px">
        <button class="btn ghost" id="nav-home">الرئيسية</button>
        <button class="btn ghost" id="nav-admin">لوحة الآدمن</button>
        <button class="btn ghost" id="btn-export">تصدير نسخة</button>
        <button class="btn ghost" id="btn-import">استيراد نسخة</button>
      </nav>
    </div>
  </header>

  <main class="container" id="view-root"></main>
  <div class="container" id="debug"></div>

  <!-- Modal PIN -->
  <div class="overlay" id="pin-overlay" role="dialog" aria-modal="true">
    <div class="modal card">
      <h3 style="margin:0 0 6px 0">أدخل الرقم السري</h3>
      <div class="muted tiny" id="pin-desc" style="margin-bottom:12px">للتحقق</div>
      <input class="input" id="pin-input" type="password" inputmode="numeric" maxlength="4" placeholder="أربع خانات" />
      <div class="row" style="margin-top:12px;gap:8px">
        <button class="btn" id="pin-confirm">تأكيد</button>
        <button class="btn muted" id="pin-cancel">إلغاء</button>
      </div>
      <div class="danger tiny" id="pin-error" style="margin-top:8px;display:none"></div>
    </div>
  </div>

  <footer>© <span id="year"></span> محفظة الادخار العالمية</footer>

  <script>
  // ========= 1) صور الحسابات =========
  const IMG = {
    admin: "https://i.postimg.cc/tTSfNWkn/image.jpg",
    omar:  "https://i.postimg.cc/LsmbdN0Z/image.jpg",
    shahad:"https://i.postimg.cc/d1xHyvQ8/image.jpg"
  };

  // ========= 2) الحالة الافتراضية =========
  const defaults = {
    pins: { omar:'4000', shahad:'5000', admin:'9000' },
    accounts: {
      omar:   { id:'omar',   name:'عمر',  balance:0, goal:{ title:'', amount:0, approved:false } },
      shahad: { id:'shahad', name:'شهد', balance:0, goal:{ title:'', amount:0, approved:false } }
    },
    txs: []
  };

  // ========= 3) التخزين المحلي + نسخة احتياطية =========
  const STORAGE_KEY = 'wsb_simple_state_v1';
  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null'); }catch{ return null; } }
  function saveLocal(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

  // تصدير/استيراد
  document.getElementById('btn-export').onclick = ()=>{
    const data = localStorage.getItem(STORAGE_KEY) || JSON.stringify(defaults);
    const blob = new Blob([data], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'wsb-backup.json';
    a.click();
  };
  document.getElementById('btn-import').onclick = ()=>{
    const inp = document.createElement('input');
    inp.type = 'file'; inp.accept = 'application/json';
    inp.onchange = (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const s = JSON.parse(fr.result);
          state = Object.assign({}, defaults, s||{});
          normalizeTx();
          saveLocal(state);
          handleRoute();
          alert('تم الاستيراد بنجاح.');
        }catch(_){ alert('ملف غير صالح'); }
      };
      fr.readAsText(file, 'utf-8');
    };
    inp.click();
  };

  let state = loadLocal() || JSON.parse(JSON.stringify(defaults));
  normalizeTx();
  saveLocal(state);

  function writeState(next){
    state = Object.assign({}, state, next||{});
    normalizeTx();
    saveLocal(state);
    handleRoute();
    return Promise.resolve();
  }

  function normalizeTx(){
    if (Array.isArray(state.txs)) state.txs = state.txs.filter(Boolean);
    else if (typeof state.txs === 'object' && state.txs) state.txs = Object.values(state.txs);
    state.txs.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
  }

  // ========= 4) التوجيه =========
  const root = document.getElementById('view-root');
  document.getElementById('nav-home').onclick = () => go('home');
  document.getElementById('nav-admin').onclick = () => go('admin');
  window.addEventListener('hashchange', handleRoute);
  function go(name){ location.hash = '#'+name; }
  function handleRoute(){
    const h = location.hash.replace(/^#/, '') || 'home';
    if (h.startsWith('account=')){
      const who = h.split('=')[1];
      who==='omar' || who==='shahad' ? routes['account:'+who]() : renderHome();
    } else {
      (routes[h] || renderHome)();
    }
  }

  const routes = {
    home: renderHome,
    'account:omar': () => requestPin('حساب عمر', 'omar').then(ok => ok ? renderAccount('omar') : renderHome()),
    'account:shahad': () => requestPin('حساب شهد', 'shahad').then(ok => ok ? renderAccount('shahad') : renderHome()),
    admin: () => requestPin('لوحة الآدمن (عبدالعزيز)', 'admin').then(ok => ok ? renderAdmin() : renderHome())
  };

  // ========= 5) واجهة عامة =========
  function fmt(n){ return Number(n).toLocaleString('ar-SA'); }
  function fmtDate(ms){ return new Date(ms).toLocaleString('ar-SA'); }
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function now(){ return Date.now(); }
  function escapeHtml(s){ return s.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

  // ========= 6) الرئيسية =========
  function goalProgress(a){
    const g = a.goal||{amount:0,approved:false}; if (!g.amount) return 0;
    const p = Math.max(0, Math.min(100, Math.round((a.balance / g.amount)*100)));
    return p;
  }
  function renderHome(){
    const pendingCount = (state.txs||[]).filter(t=>t.status==='pending').length;
    root.innerHTML = `
      <section class="card" style="padding:18px;background:linear-gradient(90deg,var(--wblue-800),var(--wblue-700));color:#fff">
        <div style="font-weight:700;font-size:18px;margin-bottom:4px">أهلًا!</div>
        <div class="muted" style="color:#e5e7eb">اختر الحساب لإرسال الطلبات، أو ادخل لوحة الآدمن للموافقة وإجراء العمليات الإدارية.</div>
        ${pendingCount? `<div class="badge" style="margin-top:8px;background:#fff;color:#111827">طلبات بانتظار الموافقة: ${pendingCount}</div>`:''}
      </section>

      <section class="grid grid-2">
        ${['omar','shahad'].map(id => {
          const a = state.accounts[id];
          const g = a.goal||{amount:0,approved:false,title:''};
          const progress = g.approved && g.amount? goalProgress(a):0;
          const img = id==='omar'? IMG.omar : IMG.shahad;
          return `
            <div class="card" style="padding:16px">
              <div class="row" style="gap:14px">
                <img src="${img}" alt="${a.name}" class="avatar"/>
                <div style="flex:1">
                  <div class="muted">رصيد الحساب</div>
                  <div class="money" style="font-weight:800;font-size:22px">${fmt(a.balance)} ر.س</div>
                  <div style="margin-top:4px;color:var(--wblue-800);font-weight:700">حساب ${a.name} الإدخاري</div>
                  ${g.amount?`
                    <div class="tiny muted" style="margin-top:6px">الهدف: ${g.title? g.title+' - ':''}${fmt(g.amount)} ر.س ${g.approved? '<span class="badge">مُعتمد</span>':'<span class="badge" style="background:#fee2e2;color:#991b1b">بانتظار موافقة</span>'}</div>
                    <div class="progress" style="margin-top:6px"><div style="width:${progress}%"></div></div>
                    <div class="tiny muted" style="margin-top:2px">${progress}%</div>
                  `:''}
                </div>
                <button class="btn" onclick="go('account=${id}')">فتح</button>
              </div>
            </div>
          `;
        }).join('')}
      </section>

      <section>
        <h3 class="section-title">أحدث العمليات</h3>
        ${renderTxList(null, 5)}
      </section>
    `;
  }

  // ========= 7) صفحة الحساب =========
  function renderAccount(id){
    const acc = state.accounts[id];
    const g = acc.goal || {title:'',amount:0,approved:false};
    const approvedProgress = g.approved && g.amount ? goalProgress(acc) : 0;
    const pendingOwn = (state.txs||[]).filter(t=>t.accountId===id && t.status==='pending').length;
    const img = id==='omar'? IMG.omar : IMG.shahad;
    root.innerHTML = `
      <section class="card" style="padding:16px">
        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:12px">
            <img src="${img}" alt="${acc.name}" class="avatar-lg"/>
            <div>
              <div class="muted">رصيد ${acc.name}</div>
              <div class="money" style="font-weight:800;font-size:26px">${fmt(acc.balance)} ر.س</div>
              ${pendingOwn? `<div class="tiny amber" style="margin-top:4px">طلبات قيد الموافقة: ${pendingOwn}</div>`:''}
            </div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn ghost" onclick="go('home')">الرئيسية</button>
          </div>
        </div>
      </section>

      <section class="grid grid-2">
        <div class="card" style="padding:16px">
          <div class="tabs">
            <div class="tab active" id="tab-dep">طلب إيداع</div>
            <div class="tab" id="tab-exp">طلب صرف</div>
            <div class="tab" id="tab-trf">طلب تحويل</div>
          </div>

          <div id="form-dep">
            <input class="input" id="dep-amount" type="number" placeholder="المبلغ بالريال" />
            <input class="input" id="dep-note"   type="text"   placeholder="ملاحظة (اختياري)" style="margin-top:8px"/>
            <button class="btn" style="margin-top:10px" onclick="requestDeposit('${id}')">إرسال طلب</button>
            <div class="tiny muted" style="margin-top:6px">سيرسل للآدمن للموافقة قبل إضافة المبلغ.</div>
          </div>

          <div id="form-exp" style="display:none">
            <input class="input" id="exp-amount" type="number" placeholder="المبلغ بالريال" />
            <input class="input" id="exp-note"   type="text"   placeholder="ملاحظة (اختياري)" style="margin-top:8px"/>
            <button class="btn" style="margin-top:10px" onclick="requestExpense('${id}')">إرسال طلب</button>
            <div class="tiny muted" style="margin-top:6px">سيرسل للآدمن للموافقة. سيتم رفض الطلب تلقائيًا إن كان الرصيد لا يكفي.</div>
          </div>

          <div id="form-trf" style="display:none">
            <input class="input" id="trf-amount" type="number" placeholder="المبلغ بالريال" />
            <select class="input" id="trf-to" style="margin-top:8px">
              <option value="abdulaziz">حساب عبدالعزيز</option>
              <option value="omar">حساب عمر</option>
              <option value="shahad">حساب شهد</option>
            </select>
            <button class="btn" style="margin-top:10px" onclick="requestTransfer('${id}')">إرسال طلب</button>
            <div class="tiny muted" style="margin-top:6px">التحويل بين الحسابات يضاف بعد موافقة الآدمن.</div>
          </div>

          <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)"/>
          <div>
            <div class="muted tiny" style="margin-bottom:6px">هدف الادخار لهذا الحساب</div>
            <input class="input" id="goal-title" type="text" placeholder="عنوان الهدف (مثال: دراجة)" value="${g.title||''}" />
            <input class="input" id="goal-amount" type="number" placeholder="مبلغ الهدف بالريال" value="${g.amount||''}" style="margin-top:8px"/>
            <div class="row" style="margin-top:8px;gap:8px">
              <button class="btn" onclick="submitGoal('${id}')">إرسال الهدف للموافقة</button>
              ${g.amount? `<span class="badge">${g.approved? 'مُعتمد':'بانتظار موافقة'}</span>`:''}
            </div>
            ${g.amount && g.approved ? `
              <div class="progress" style="margin-top:8px"><div style="width:${approvedProgress}%"></div></div>
              <div class="tiny muted" style="margin-top:2px">${approvedProgress}%</div>
            `:''}
          </div>
        </div>

        <div class="card" style="padding:16px">
          <div class="row" style="justify-content:space-between;margin-bottom:8px">
            <h3 class="section-title">سجل العمليات</h3>
            <span class="badge">الحساب: ${acc.name}</span>
          </div>
          ${renderTxList(id)}
        </div>
      </section>
    `;
    const tabDep = document.getElementById('tab-dep');
    const tabExp = document.getElementById('tab-exp');
    const tabTrf = document.getElementById('tab-trf');
    const Fdep = document.getElementById('form-dep');
    const Fexp = document.getElementById('form-exp');
    const Ftrf = document.getElementById('form-trf');

    tabDep.onclick = ()=>{ tabDep.classList.add('active'); tabExp.classList.remove('active'); tabTrf.classList.remove('active'); Fdep.style.display='block'; Fexp.style.display='none'; Ftrf.style.display='none'; };
    tabExp.onclick = ()=>{ tabExp.classList.add('active'); tabDep.classList.remove('active'); tabTrf.classList.remove('active'); Fexp.style.display='block'; Fdep.style.display='none'; Ftrf.style.display='none'; };
    tabTrf.onclick = ()=>{ tabTrf.classList.add('active'); tabDep.classList.remove('active'); tabExp.classList.remove('active'); Ftrf.style.display='block'; Fdep.style.display='none'; };
  }

  // ========= 8) لوحة الآدمن =========
  function renderAdmin(){
    const a = state.accounts;
    const pending = (state.txs||[]).filter(t=>t.status==='pending');
    const approved = (state.txs||[]).filter(t=>t.status==='approved');
    const rejected = (state.txs||[]).filter(t=>t.status==='rejected');

    const totals = (id)=>{
      const dep = approved.filter(t=>t.accountId===id && (t.type==='deposit'||t.type==='transfer-in')).reduce((s,t)=>s+t.amount,0);
      const out = approved.filter(t=>t.accountId===id && (t.type==='expense'||t.type==='transfer-out')).reduce((s,t)=>s+t.amount,0);
      return {dep,out,net:dep-out};
    };

    root.innerHTML = `
      <section class="card" style="padding:16px">
        <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:12px">
          <div class="row" style="gap:12px">
            <img src="${IMG.admin}" alt="عبدالعزيز" class="avatar-lg"/>
            <div>
              <div class="muted">لوحة الآدمن</div>
              <div style="font-weight:800;font-size:18px">نظرة عامة</div>
              <div class="tiny muted">بانتظار: ${pending.length} — موافق: ${approved.length} — مرفوض: ${rejected.length}</div>
            </div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn ghost" onclick="go('home')">الرئيسية</button>
          </div>
        </div>
      </section>

      <section class="grid grid-3">
        ${['omar','shahad'].map(id=>{
          const t = totals(id);
          const img = id==='omar'? IMG.omar : IMG.shahad;
          return `
          <div class="card" style="padding:16px">
            <div class="row" style="gap:12px">
              <img src="${img}" alt="${a[id].name}" class="avatar"/>
              <div>
                <div class="muted">رصيد ${a[id].name}</div>
                <div class="money" style="font-weight:800;font-size:22px">${fmt(a[id].balance)} ر.س</div>
                <div class="tiny muted" style="margin-top:6px">إجمالي الإيداعات/الإضافات: ${fmt(t.dep)} ر.س</div>
                <div class="tiny muted">إجمالي المصروفات/الخصومات: ${fmt(t.out)} ر.س</div>
                <div class="tiny ${t.net>=0?'success':'danger'}">الصافي: ${fmt(t.net)} ر.س</div>
              </div>
            </div>
            ${a[id].goal?.amount?`
              <div class="tiny muted" style="margin-top:6px">الهدف: ${a[id].goal.title? a[id].goal.title+' - ':''}${fmt(a[id].goal.amount)} ر.س ${a[id].goal.approved? '<span class="badge">مُعتمد</span>':'<span class="badge" style="background:#fee2e2;color:#991b1b">بانتظار موافقة</span>'}</div>
              ${a[id].goal.approved? `<div class="progress" style="margin-top:6px"><div style="width:${goalProgress(a[id])}%"></div></div>`:''}
            `:''}
            <div class="row" style="gap:8px;margin-top:10px">
              <button class="btn" onclick="go('account=${id}')">فتح الحساب</button>
            </div>
          </div>`;
        }).join('')}

        <div class="card" style="padding:16px">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="muted">أدوات سريعة</div>
              <div class="tiny muted">تصفير السجلات أو الأرصدة (مع تأكيد)</div>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn warn" onclick="confirmReset('txs')">تصفير السجلات</button>
              <button class="btn danger" onclick="confirmReset('balances')">تصفير الأرصدة</button>
            </div>
          </div>
        </div>
      </section>

      <section class="card" style="padding:16px;margin-top:8px">
        <div class="tabs">
          <div id="tab-pending"  class="tab active">بانتظار</div>
          <div id="tab-approved" class="tab">موافق عليه</div>
          <div id="tab-rejected" class="tab">مرفوض</div>
        </div>

        <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:10px">
          <select id="f-account" class="input" style="max-width:180px">
            <option value="">كل الحسابات</option>
            <option value="omar">عمر</option>
            <option value="shahad">شهد</option>
          </select>
          <select id="f-type" class="input" style="max-width:200px">
            <option value="">كل الأنواع</option>
            <option value="deposit">إيداع</option>
            <option value="expense">مصروف</option>
            <option value="transfer-in">تحويل - إضافة</option>
            <option value="transfer-out">تحويل - خصم</option>
          </select>
          <select id="f-party" class="input" style="max-width:200px">
            <option value="">كل الجهات</option>
            <option value="abdulaziz">عبدالعزيز</option>
            <option value="omar">عمر</option>
            <option value="shahad">شهد</option>
          </select>
          <input id="f-from" class="input" type="date" style="max-width:170px"/>
          <input id="f-to" class="input" type="date" style="max-width:170px"/>
          <button class="btn" onclick="renderAdminTx()">تطبيق الفلاتر</button>
        </div>
        <div id="admin-tx"></div>
      </section>

      <section class="card" style="padding:16px;margin-top:8px">
        <h3 class="section-title">طلبات أهداف الادخار</h3>
        <div id="goal-requests"></div>
      </section>
    `;

    document.getElementById('tab-pending').onclick = ()=>switchTxTab('pending');
    document.getElementById('tab-approved').onclick = ()=>switchTxTab('approved');
    document.getElementById('tab-rejected').onclick = ()=>switchTxTab('rejected');

    renderAdminTx();
    renderGoalRequests();
  }

  function switchTxTab(tab){
    document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('active'));
    document.getElementById('tab-'+tab).classList.add('active');
    renderAdminTx(tab);
  }

  function renderAdminTx(activeTab){
    const active = activeTab || (document.querySelector('.tabs .tab.active')?.id.replace('tab-','') || 'pending');
    const acc = document.getElementById('f-account')?.value || '';
    const typ = document.getElementById('f-type')?.value || '';
    const par = document.getElementById('f-party')?.value || '';
    const from = document.getElementById('f-from')?.value ? new Date(document.getElementById('f-from').value) : null;
    const to   = document.getElementById('f-to')?.value ? new Date(document.getElementById('f-to').value)   : null;

    let list = [...(state.txs||[])].filter(t=>t.status===active);
    if (acc) list = list.filter(t=>t.accountId===acc);
    if (typ) list = list.filter(t=>t.type===typ);
    if (par) list = list.filter(t=> (t.counterparty||'')===par);
    if (from) list = list.filter(t=> new Date(t.createdAt) >= from);
    if (to)   list = list.filter(t=> new Date(t.createdAt) <= new Date(to.getTime()+86400000-1));

    const el = document.getElementById('admin-tx');
    if (list.length===0){ el.innerHTML = `<div class="empty card" style="padding:14px">لا توجد عمليات</div>`; return; }

    el.innerHTML = `
      <div class="list">
        ${list.map(t=>{
          const {label, cls, sign} = txLabel(t);
          const controls = t.status==='pending' ? `
            <div class="row" style="gap:6px">
              <button class="btn" onclick="approveTx('${t.id}')">موافقة</button>
              <button class="btn danger" onclick="rejectTx('${t.id}')">رفض</button>
            </div>` : `<span class="badge">${t.status==='approved'?'موافق عليه':'مرفوض'}</span>`;
          return `
            <div class="item">
              <div>
                <div style="font-weight:700">${label} — <span class="muted tiny">${t.accountId==='omar'?'عمر':'شهد'}</span></div>
                <div class="muted tiny">${fmtDate(t.createdAt)}</div>
                ${t.note? `<div class="tiny" style="margin-top:3px">ملاحظة: ${escapeHtml(t.note)}</div>`:''}
              </div>
              <div class="row" style="gap:10px">
                <div class="money ${cls}" style="font-weight:800">${sign}${fmt(t.amount)} ر.س</div>
                ${controls}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  function renderGoalRequests(){
    const items = ['omar','shahad'].map(id=>{
      const g = state.accounts[id].goal;
      if (!g || !g.amount) return '';
      if (g.approved) return `
        <div class="item">
          <div>
            <div style="font-weight:700">${state.accounts[id].name} — هدف مُعتمد</div>
            <div class="tiny muted">${g.title? escapeHtml(g.title)+' — ':''}${fmt(g.amount)} ر.س</div>
          </div>
          <span class="badge">مُعتمد</span>
        </div>`;
      return `
        <div class="item">
          <div>
            <div style="font-weight:700">${state.accounts[id].name} — طلب هدف</div>
            <div class="tiny muted">${g.title? escapeHtml(g.title)+' — ':''}${fmt(g.amount)} ر.س</div>
          </div>
          <div class="row" style="gap:6px">
            <button class="btn" onclick="approveGoal('${id}')">موافقة</button>
            <button class="btn danger" onclick="rejectGoal('${id}')">رفض</button>
          </div>
        </div>`;
    }).filter(Boolean);

    document.getElementById('goal-requests').innerHTML =
      items.length? `<div class="list">${items.join('')}</div>` :
      `<div class="empty card" style="padding:14px">لا توجد طلبات أهداف</div>`;
  }

  // ========= 9) ملصقات العمليات =========
  function txLabel(t){
    const label =
      t.type==='deposit' ? 'إيداع' :
      t.type==='expense' ? 'مصروف' :
      t.type==='transfer-in' ? `تحويل - إضافة (${nameOf(t.counterparty)})` :
      t.type==='transfer-out' ? `تحويل - خصم (${nameOf(t.counterparty)})` : t.type;
    const cls = (t.type==='expense' || t.type==='transfer-out') ? 'danger' : 'success';
    const sign = (t.type==='expense' || t.type==='transfer-out') ? '-' : '+';
    return {label, cls, sign};
  }
  function nameOf(id){
    if (id==='omar') return 'عمر';
    if (id==='shahad') return 'شهد';
    if (id==='abdulaziz') return 'عبدالعزيز';
    return id||'';
  }
  function renderTxList(accountId, limit){
    let list = (state.txs||[]);
    if (accountId) list = list.filter(t=>t.accountId===accountId);
    list = list.slice(0, limit||list.length);
    if (list.length===0) return `<div class="card empty" style="padding:14px">لا توجد عمليات بعد</div>`;
    return `
      <div class="list">
        ${list.map(t=>{
          const {label, cls, sign} = txLabel(t);
          const st = t.status==='pending' ? '<span class="badge" style="background:#fef3c7;color:#92400e">بانتظار</span>' :
                     t.status==='approved'? '<span class="badge">موافق عليه</span>' :
                     '<span class="badge" style="background:#fee2e2;color:#991b1b">مرفوض</span>';
          return `
            <div class="item">
              <div>
                <div style="font-weight:700">${label} ${st}</div>
                <div class="muted tiny">${fmtDate(t.createdAt)}</div>
                ${t.note? `<div class="tiny" style="margin-top:3px">ملاحظة: ${escapeHtml(t.note)}</div>`:''}
              </div>
              <div class="money ${cls}" style="font-weight:800">${sign}${fmt(t.amount)} ر.س</div>
            </div>`;
        }).join('')}
      </div>
    `;
  }

  // ========= 10) إنشاء الطلبات =========
  function pushTx(tx){
    state.txs.unshift(tx);
    return writeState({ txs: state.txs });
  }

  function requestDeposit(id){
    const amount = Number(document.getElementById('dep-amount').value || 0);
    const note = document.getElementById('dep-note').value.trim();
    if (!amount || amount<=0) return alert('أدخل مبلغ صحيح');
    const tx = {id:uid(), accountId:id, type:'deposit', amount, note, createdAt:now(), status:'pending'};
    pushTx(tx).then(()=> alert('تم إرسال طلب الإيداع للآدمن للموافقة.'));
  }

  function requestExpense(id){
    const amount = Number(document.getElementById('exp-amount').value || 0);
    const note = document.getElementById('exp-note').value.trim();
    if (!amount || amount<=0) return alert('أدخل مبلغ صحيح');
    if (state.accounts[id].balance < amount) return alert('الرصيد لا يكفي لطلب الصرف.');
    const tx = {id:uid(), accountId:id, type:'expense', amount, note, createdAt:now(), status:'pending'};
    pushTx(tx).then(()=> alert('تم إرسال طلب الصرف للآدمن للموافقة.'));
  }

  function requestTransfer(fromId){
    const amount = Number(document.getElementById('trf-amount').value || 0);
    const to = document.getElementById('trf-to').value;
    if (!amount || amount<=0) return alert('أدخل مبلغ صحيح');
    if (to === fromId) return alert('لا يمكن التحويل لنفس الحساب');
    if (state.accounts[fromId].balance < amount) return alert('الرصيد لا يكفي للتحويل.');
    const outTx = {id:uid(), accountId:fromId, type:'transfer-out', amount, counterparty:to, createdAt:now(), status:'pending'};
    const list = [outTx];
    if (to==='omar' || to==='shahad'){
      const inTx = {id:uid(), accountId:to, type:'transfer-in', amount, counterparty:fromId, createdAt:now(), status:'pending', pair:outTx.id};
      outTx.pair = inTx.id;
      list.push(inTx);
    }
    state.txs = list.concat(state.txs);
    writeState({ txs: state.txs }).then(()=> alert('تم إرسال طلب التحويل للآدمن للموافقة.'));
  }

  // ========= 11) موافقات الآدمن =========
  function approveTx(id){
    const t = (state.txs||[]).find(x=>x.id===id);
    if (!t || t.status!=='pending') return;
    const a = state.accounts;

    if (t.type==='expense' || t.type==='transfer-out'){
      if (a[t.accountId].balance < t.amount){ alert('لا يمكن الموافقة: الرصيد لا يكفي'); return; }
      a[t.accountId].balance -= t.amount;
    } else if (t.type==='deposit' || t.type==='transfer-in'){
      a[t.accountId].balance += t.amount;
    }
    t.status = 'approved';

    if ((t.type==='transfer-in' || t.type==='transfer-out') && t.pair){
      const p = (state.txs||[]).find(x=>x.id===t.pair);
      if (p && p.status==='pending'){
        if (p.type==='transfer-in'){ a[p.accountId].balance += p.amount; }
        if (p.type==='transfer-out'){
          if (a[p.accountId].balance >= p.amount){ a[p.accountId].balance -= p.amount; }
        }
        p.status = 'approved';
      }
    }
    writeState({ accounts: a, txs: state.txs });
  }

  function rejectTx(id){
    const t = (state.txs||[]).find(x=>x.id===id);
    if (!t || t.status!=='pending') return;
    t.status = 'rejected';
    if ((t.type==='transfer-in' || t.type==='transfer-out') && t.pair){
      const p = (state.txs||[]).find(x=>x.id===t.pair);
      if (p && p.status==='pending'){ p.status='rejected'; }
    }
    writeState({ txs: state.txs });
  }

  // ========= 12) أهداف =========
  function submitGoal(id){
    const title = document.getElementById('goal-title').value.trim();
    const amount = Number(document.getElementById('goal-amount').value || 0);
    if (!amount || amount<=0) return alert('أدخل مبلغ هدف صحيح');
    state.accounts[id].goal = { title, amount, approved:false };
    writeState({ accounts: state.accounts }).then(()=> alert('تم إرسال هدف الادخار للآدمن للموافقة.'));
  }
  function approveGoal(id){
    const g = state.accounts[id].goal; if (!g) return;
    g.approved = true;
    writeState({ accounts: state.accounts });
  }
  function rejectGoal(id){
    state.accounts[id].goal = { title:'', amount:0, approved:false };
    writeState({ accounts: state.accounts });
  }

  // ========= 13) PIN =========
  const ovl = document.getElementById('pin-overlay');
  const pinInput = document.getElementById('pin-input');
  const pinDesc = document.getElementById('pin-desc');
  const pinErr = document.getElementById('pin-error');
  document.getElementById('pin-cancel').onclick = ()=>{ hidePin(false); };

  let pinResolve = null, whoKey = '';
  const pinFail = { omar:0, shahad:0, admin:0 };
  const lockUntil = { omar:0, shahad:0, admin:0 };

  document.getElementById('pin-confirm').onclick = ()=> confirmPin();
  function requestPin(title, who){
    whoKey = who;
    const nowt = Date.now();
    if (lockUntil[who] && nowt < lockUntil[who]){
      const secs = Math.ceil((lockUntil[who] - nowt)/1000);
      alert('محاولات كثيرة خاطئة. الرجاء المحاولة بعد '+secs+' ثانية.');
      return Promise.resolve(false);
    }
    pinDesc.textContent = 'للتحقق من ' + title + ' — وضع محلي';
    pinInput.value = '';
    pinErr.style.display = 'none';
    ovl.style.display = 'grid';
    return new Promise(res => { pinResolve = res; setTimeout(()=>pinInput.focus(), 30); });
  }
  function hidePin(ok){ ovl.style.display = 'none'; if (pinResolve){ pinResolve(ok); pinResolve = null; } }
  function confirmPin(){
    const v = pinInput.value.trim();
    if (v === state.pins[whoKey]){
      pinFail[whoKey] = 0; hidePin(true);
    } else {
      pinFail[whoKey] = (pinFail[whoKey]||0) + 1;
      if (pinFail[whoKey] >= 3){
        lockUntil[whoKey] = Date.now()+60000;
        pinErr.style.display='block'; pinErr.textContent='تم الإغلاق المؤقت لمدة 60 ثانية بسبب 3 محاولات خاطئة.';
      } else {
        pinErr.style.display='block'; pinErr.textContent='الرقم السري غير صحيح. المحاولة: '+pinFail[whoKey]+'/3';
      }
    }
  }

  // ========= 14) بدء التشغيل =========
  document.getElementById('year').textContent = new Date().getFullYear();
  handleRoute();

  function confirmReset(type){
    if (!confirm('تأكيد العملية؟ لا يمكن التراجع.')) return;
    if (type==='txs'){ state.txs = []; }
    if (type==='balances'){
      state.accounts.omar.balance = 0;
      state.accounts.shahad.balance = 0;
    }
    writeState({ accounts: state.accounts, txs: state.txs });
  }
  </script>
</body>
</html>
